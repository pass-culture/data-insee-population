/**
 * DuckDB-WASM singleton and query helpers.
 * Uses local WASM files (not CDN) to work with COEP headers.
 */
import * as duckdb from "@duckdb/duckdb-wasm";
import duckdbWasm from "@duckdb/duckdb-wasm/dist/duckdb-mvp.wasm?url";
import duckdbWorker from "@duckdb/duckdb-wasm/dist/duckdb-browser-mvp.worker.js?url";
import duckdbWasmEh from "@duckdb/duckdb-wasm/dist/duckdb-eh.wasm?url";
import duckdbWorkerEh from "@duckdb/duckdb-wasm/dist/duckdb-browser-eh.worker.js?url";

let db = null;
let conn = null;

const PARQUET_BASE = "/data";

export async function initDB() {
  if (db) return conn;

  const MANUAL_BUNDLES = {
    mvp: {
      mainModule: duckdbWasm,
      mainWorker: duckdbWorker,
    },
    eh: {
      mainModule: duckdbWasmEh,
      mainWorker: duckdbWorkerEh,
    },
  };

  const bundle = await duckdb.selectBundle(MANUAL_BUNDLES);
  const worker = new Worker(bundle.mainWorker);
  const logger = new duckdb.VoidLogger();

  db = new duckdb.AsyncDuckDB(logger, worker);
  await db.instantiate(bundle.mainModule);

  conn = await db.connect();

  // Register parquet files via HTTP for DuckDB to fetch directly
  await db.registerFileURL(
    "population_department.parquet",
    `${location.origin}${PARQUET_BASE}/population_department.parquet`,
    duckdb.DuckDBDataProtocol.HTTP,
    false
  );
  await db.registerFileURL(
    "population_epci.parquet",
    `${location.origin}${PARQUET_BASE}/population_epci.parquet`,
    duckdb.DuckDBDataProtocol.HTTP,
    false
  );

  // Create views
  await conn.query(`
    CREATE VIEW dept AS
    SELECT * FROM read_parquet('population_department.parquet')
  `);

  await conn.query(`
    CREATE VIEW epci AS
    SELECT * FROM read_parquet('population_epci.parquet')
  `);

  // Bias comparison tables (optional â€” generated by prepare_dashboard_data.py step 6)
  for (const [file, view] of [
    ["bias_comparison.parquet", "bias_comparison"],
    ["geo_coverage.parquet", "geo_coverage"],
  ]) {
    try {
      await db.registerFileURL(
        file,
        `${location.origin}${PARQUET_BASE}/${file}`,
        duckdb.DuckDBDataProtocol.HTTP,
        false
      );
      await conn.query(`CREATE VIEW ${view} AS SELECT * FROM read_parquet('${file}')`);
    } catch {
      console.warn(`[db] ${file} not available (run prepare_dashboard_data.py step 6)`);
    }
  }

  console.log("[db] DuckDB initialized, views created");
  return conn;
}

/**
 * Load canton data for a specific department (lazy).
 * Creates a view named canton_{deptCode} (e.g. canton_75).
 */
export async function loadCantonDepartment(deptCode) {
  const viewName = `canton_${deptCode.replace(/[^a-zA-Z0-9]/g, "")}`;

  try {
    const check = await conn.query(
      `SELECT 1 FROM information_schema.tables WHERE table_name = '${viewName}'`
    );
    if (check.numRows > 0) return viewName;
  } catch {
    // View doesn't exist, create it
  }

  const fileName = `population_canton_${deptCode}.parquet`;
  const fileUrl = `${location.origin}${PARQUET_BASE}/canton/${fileName}`;

  try {
    await db.registerFileURL(
      fileName,
      fileUrl,
      duckdb.DuckDBDataProtocol.HTTP,
      false
    );
    await conn.query(`
      CREATE VIEW ${viewName} AS
      SELECT * FROM read_parquet('${fileName}')
    `);
    console.log(`[db] Loaded canton for dept ${deptCode}`);
  } catch (e) {
    console.warn(`[db] Failed to load canton for dept ${deptCode}:`, e.message);
    return null;
  }

  return viewName;
}

/**
 * Load IRIS data for a specific department (lazy).
 * Creates a view named iris_{deptCode} (e.g. iris_75).
 */
export async function loadIrisDepartment(deptCode) {
  const viewName = `iris_${deptCode.replace(/[^a-zA-Z0-9]/g, "")}`;

  // Check if already loaded
  try {
    const check = await conn.query(
      `SELECT 1 FROM information_schema.tables WHERE table_name = '${viewName}'`
    );
    if (check.numRows > 0) return viewName;
  } catch {
    // View doesn't exist, create it
  }

  const fileName = `population_iris_${deptCode}.parquet`;
  const fileUrl = `${location.origin}${PARQUET_BASE}/iris/${fileName}`;

  try {
    await db.registerFileURL(
      fileName,
      fileUrl,
      duckdb.DuckDBDataProtocol.HTTP,
      false
    );
    await conn.query(`
      CREATE VIEW ${viewName} AS
      SELECT * FROM read_parquet('${fileName}')
    `);
    console.log(`[db] Loaded IRIS for dept ${deptCode}`);
  } catch (e) {
    console.warn(`[db] Failed to load IRIS for dept ${deptCode}:`, e.message);
    return null;
  }

  return viewName;
}

/**
 * Run a SQL query and return results as an array of objects.
 */
export async function query(sql) {
  const result = await conn.query(sql);
  return resultToObjects(result);
}

/**
 * Convert Arrow table result to array of plain objects.
 */
function resultToObjects(result) {
  const rows = [];
  const schema = result.schema.fields.map((f) => f.name);
  const columns = schema.map((_, i) => result.getChildAt(i));

  for (let i = 0; i < result.numRows; i++) {
    const row = {};
    for (let j = 0; j < schema.length; j++) {
      const val = columns[j].get(i);
      row[schema[j]] = typeof val === "bigint" ? Number(val) : val;
    }
    rows.push(row);
  }
  return rows;
}

export function getConnection() {
  return conn;
}
